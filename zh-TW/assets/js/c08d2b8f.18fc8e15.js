"use strict";(self.webpackChunk_2_ndbrain=self.webpackChunk_2_ndbrain||[]).push([[2538],{9654:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>r,metadata:()=>d,toc:()=>l});var t=s(5893),i=s(1151);const r={},c="\u5e42\u7b49\u6027\u8a2d\u8a08",d={id:"backend/api-idempotent-design",title:"\u5e42\u7b49\u6027\u8a2d\u8a08",description:"\u5e42\u7b49\u6027\u662f\u6307\u7121\u8ad6\u4e00\u500b\u64cd\u4f5c\u57f7\u884c\u591a\u5c11\u6b21\uff0c\u7d50\u679c\u90fd\u4fdd\u6301\u4e00\u81f4\u3002\u5c0d\u65bc API \u8a2d\u8a08\u4f86\u8aaa\uff0c\u9019\u662f\u4e00\u500b\u91cd\u8981\u7684\u7279\u6027\uff0c\u5c24\u5176\u662f\u5728\u8655\u7406\u652f\u4ed8\u3001\u4ea4\u6613\u6216\u5176\u4ed6\u9700\u8981\u4fdd\u6301\u8cc7\u6599\u4e00\u81f4\u6027\u7684\u5834\u666f\u4e2d\u3002\u5728 Rust \u4e2d\u5be6\u4f5c API \u7684\u5e42\u7b49\u6027\uff0c\u53ef\u4ee5\u900f\u904e\u591a\u7a2e\u65b9\u5f0f\uff0c\u4ee5\u4e0b\u662f\u4e00\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff0c\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 Rust \u548c\u4e00\u500b\u5047\u8a2d\u7684\u8cc7\u6599\u5132\u5b58\uff08\u4f8b\u5982 Redis \u6216\u4efb\u4f55\u9375\u503c\u5132\u5b58\u7cfb\u7d71\uff09\u4f86\u78ba\u4fdd\u4e00\u500b\u64cd\u4f5c\u7684\u5e42\u7b49\u6027\u3002",source:"@site/docs/backend/api-idempotent-design.md",sourceDirName:"backend",slug:"/backend/api-idempotent-design",permalink:"/zh-TW/docs/backend/api-idempotent-design",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"backendSidebar",previous:{title:"Introduction",permalink:"/zh-TW/docs/backend/introduction"},next:{title:"\u6574\u5408\u6e2c\u8a66 Rust API",permalink:"/zh-TW/docs/backend/end-to-end-test"}},a={},l=[{value:"\u5be6\u4f5c\u5e42\u7b49\u6027",id:"\u5be6\u4f5c\u5e42\u7b49\u6027",level:2},{value:"\u6b65\u9a5f 1: \u5b9a\u7fa9\u8acb\u6c42\u548c\u97ff\u61c9\u7d50\u69cb",id:"\u6b65\u9a5f-1-\u5b9a\u7fa9\u8acb\u6c42\u548c\u97ff\u61c9\u7d50\u69cb",level:3},{value:"\u6b65\u9a5f 2: \u5be6\u4f5c\u5e42\u7b49\u6027\u6aa2\u67e5",id:"\u6b65\u9a5f-2-\u5be6\u4f5c\u5e42\u7b49\u6027\u6aa2\u67e5",level:3},{value:"\u6b65\u9a5f 3: \u8655\u7406\u8acb\u6c42",id:"\u6b65\u9a5f-3-\u8655\u7406\u8acb\u6c42",level:3},{value:"\u58d3\u529b\u6e2c\u8a66",id:"\u58d3\u529b\u6e2c\u8a66",level:2},{value:"\u6b65\u9a5f 1: \u52a0\u5165\u4f9d\u8cf4",id:"\u6b65\u9a5f-1-\u52a0\u5165\u4f9d\u8cf4",level:3},{value:"\u6b65\u9a5f 2: \u5be6\u4f5c\u58d3\u529b\u6e2c\u8a66",id:"\u6b65\u9a5f-2-\u5be6\u4f5c\u58d3\u529b\u6e2c\u8a66",level:3},{value:"\u8aaa\u660e",id:"\u8aaa\u660e",level:3}];function o(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"\u5e42\u7b49\u6027\u8a2d\u8a08",children:"\u5e42\u7b49\u6027\u8a2d\u8a08"}),"\n",(0,t.jsx)(n.p,{children:"\u5e42\u7b49\u6027\u662f\u6307\u7121\u8ad6\u4e00\u500b\u64cd\u4f5c\u57f7\u884c\u591a\u5c11\u6b21\uff0c\u7d50\u679c\u90fd\u4fdd\u6301\u4e00\u81f4\u3002\u5c0d\u65bc API \u8a2d\u8a08\u4f86\u8aaa\uff0c\u9019\u662f\u4e00\u500b\u91cd\u8981\u7684\u7279\u6027\uff0c\u5c24\u5176\u662f\u5728\u8655\u7406\u652f\u4ed8\u3001\u4ea4\u6613\u6216\u5176\u4ed6\u9700\u8981\u4fdd\u6301\u8cc7\u6599\u4e00\u81f4\u6027\u7684\u5834\u666f\u4e2d\u3002\u5728 Rust \u4e2d\u5be6\u4f5c API \u7684\u5e42\u7b49\u6027\uff0c\u53ef\u4ee5\u900f\u904e\u591a\u7a2e\u65b9\u5f0f\uff0c\u4ee5\u4e0b\u662f\u4e00\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff0c\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 Rust \u548c\u4e00\u500b\u5047\u8a2d\u7684\u8cc7\u6599\u5132\u5b58\uff08\u4f8b\u5982 Redis \u6216\u4efb\u4f55\u9375\u503c\u5132\u5b58\u7cfb\u7d71\uff09\u4f86\u78ba\u4fdd\u4e00\u500b\u64cd\u4f5c\u7684\u5e42\u7b49\u6027\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u5be6\u4f5c\u5e42\u7b49\u6027",children:"\u5be6\u4f5c\u5e42\u7b49\u6027"}),"\n",(0,t.jsx)(n.p,{children:"\u5047\u8a2d\u6211\u5011\u6709\u4e00\u500b API\uff0c\u7528\u65bc\u8655\u7406\u7528\u6236\u7684\u5e33\u6236\u5132\u503c\u64cd\u4f5c\uff0c\u6211\u5011\u5e0c\u671b\u9019\u500b\u64cd\u4f5c\u662f\u5e42\u7b49\u7684\uff0c\u5373\u591a\u6b21\u63d0\u4ea4\u76f8\u540c\u7684\u5132\u503c\u8acb\u6c42\u4e0d\u6703\u91cd\u8907\u589e\u52a0\u7528\u6236\u7684\u5e33\u6236\u9918\u984d\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u6b65\u9a5f-1-\u5b9a\u7fa9\u8acb\u6c42\u548c\u97ff\u61c9\u7d50\u69cb",children:"\u6b65\u9a5f 1: \u5b9a\u7fa9\u8acb\u6c42\u548c\u97ff\u61c9\u7d50\u69cb"}),"\n",(0,t.jsx)(n.p,{children:"\u9996\u5148\uff0c\u6211\u5011\u5b9a\u7fa9\u8acb\u6c42\u548c\u97ff\u61c9\u7684\u8cc7\u6599\u7d50\u69cb\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"use serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::sync::Mutex;\nlazy_static::lazy_static! {\n    static ref REQUEST_CACHE: Mutex<HashMap<String, String>> = Mutex::new(HashMap::new());\n}\n\n#[derive(Deserialize)]\nstruct RechargeRequest {\n    user_id: u64,\n    amount: u64,\n    transaction_id: String, // \u7528\u65bc\u5e42\u7b49\u6027\u6aa2\u67e5\u7684\u552f\u4e00\u6a19\u8b58\n}\n\n#[derive(Serialize)]\nstruct RechargeResponse {\n    success: bool,\n    message: String,\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u6b65\u9a5f-2-\u5be6\u4f5c\u5e42\u7b49\u6027\u6aa2\u67e5",children:"\u6b65\u9a5f 2: \u5be6\u4f5c\u5e42\u7b49\u6027\u6aa2\u67e5"}),"\n",(0,t.jsx)(n.p,{children:"\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5be6\u4f5c\u4e00\u500b\u7c21\u55ae\u7684\u51fd\u6578\u4f86\u6aa2\u67e5\u662f\u5426\u5df2\u7d93\u8655\u7406\u904e\u76f8\u540c\u7684\u5132\u503c\u8acb\u6c42\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:'fn check_idempotency(request: &RechargeRequest) -> bool {\n    let mut cache = REQUEST_CACHE.lock().unwrap();\n    if cache.contains_key(&request.transaction_id) {\n        // \u5982\u679c transaction_id \u5df2\u5b58\u5728\uff0c\u8868\u793a\u8acb\u6c42\u5df2\u8655\u7406\uff0c\u8fd4\u56de false\n        false\n    } else {\n        // \u5426\u5247\uff0c\u5c07 transaction_id \u5b58\u5165 cache \u4e26\u8655\u7406\u8acb\u6c42\uff0c\u8fd4\u56de true\n        cache.insert(request.transaction_id.clone(), "processed".to_string());\n        true\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6b65\u9a5f-3-\u8655\u7406\u8acb\u6c42",children:"\u6b65\u9a5f 3: \u8655\u7406\u8acb\u6c42"}),"\n",(0,t.jsxs)(n.p,{children:["\u6700\u5f8c\uff0c\u6211\u5011\u5be6\u4f5c\u4e00\u500b\u51fd\u6578\u4f86\u8655\u7406\u5132\u503c\u8acb\u6c42\uff0c\u4e26\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"check_idempotency"})," \u51fd\u6578\u78ba\u4fdd\u5e42\u7b49\u6027\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:'fn process_recharge_request(request: RechargeRequest) -> RechargeResponse {\n    if check_idempotency(&request) {\n        // \u6a21\u64ec\u8655\u7406\u5132\u503c\u64cd\u4f5c...\n\n        RechargeResponse {\n            success: true,\n            message: "Recharge processed successfully.".to_string(),\n        }\n    } else {\n        RechargeResponse {\n            success: false,\n            message: "Duplicate request, recharge not processed.".to_string(),\n        }\n    }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u5168\u5c40\u7684 ",(0,t.jsx)(n.code,{children:"HashMap"}),"\uff08\u900f\u904e ",(0,t.jsx)(n.code,{children:"lazy_static"})," macro \u521d\u59cb\u5316\uff09\u4f86\u5132\u5b58\u5df2\u8655\u7406\u7684\u5132\u503c\u8acb\u6c42\u7684 transaction_id\u3002\u9019\u662f\u4e00\u500b\u7c21\u5316\u7684\u4f8b\u5b50\uff0c\u5728\u5be6\u969b\u61c9\u7528\u4e2d\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u5916\u90e8\u8cc7\u6599\u5132\u5b58\u4f86\u5be6\u4f5c\u5e42\u7b49\u6027\u6aa2\u67e5\uff0c\u4ee5\u652f\u6301\u6a6b\u5411\u64f4\u5c55\u548c\u6301\u4e45\u5316\u5132\u5b58\u3002"]}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u672c\u4f8b\u4e2d\u4f7f\u7528\u7684 ",(0,t.jsx)(n.code,{children:"lazy_static"})," \u548c ",(0,t.jsx)(n.code,{children:"Mutex"})," \u4f86\u5be6\u4f5c\u5168\u5c40\u53ef\u8b8a\u72c0\u614b\u662f\u4e00\u7a2e\u7c21\u5316\u7684\u505a\u6cd5\uff0c\u9069\u5408"]}),(0,t.jsx)(n.p,{children:"\u65bc\u8aaa\u660e\u76ee\u7684\u3002\u5728\u5be6\u969b\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u61c9\u8003\u616e\u66f4\u9ad8\u6548\u80fd\u3001\u66f4\u5b89\u5168\u7684\u65b9\u5f0f\u4f86\u7ba1\u7406\u72c0\u614b\u548c\u4e26\u767c\uff0c\u4f8b\u5982\u4f7f\u7528\u5206\u4f48\u5f0f\u9396\u6216\u5206\u4f48\u5f0f\u8cc7\u6599\u5132\u5b58\u7cfb\u7d71\u3002"})]}),"\n",(0,t.jsx)(n.h2,{id:"\u58d3\u529b\u6e2c\u8a66",children:"\u58d3\u529b\u6e2c\u8a66"}),"\n",(0,t.jsxs)(n.p,{children:["\u8981\u6a21\u64ec\u9ad8\u4f75\u767c\uff08\u5982\u6bcf\u79d2 10000 \u8acb\u6c42\uff0c\u7c21\u7a31 rps\uff09\u7684\u60c5\u6cc1\uff0c\u4e26\u5c0d\u4e0a\u8ff0\u7bc4\u4f8b\u4ee3\u78bc\u9032\u884c\u58d3\u529b\u6e2c\u8a66\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 Rust \u7684\u975e\u540c\u6b65\u7279\u6027\uff0c\u914d\u5408\u4e00\u500b\u9ad8\u6548\u80fd\u7684 HTTP \u5ba2\u6236\u7aef\u5957\u4ef6\u5982 ",(0,t.jsx)(n.code,{children:"reqwest"}),"\uff08\u7528\u65bc\u767c\u9001 HTTP \u8acb\u6c42\uff09\u548c ",(0,t.jsx)(n.code,{children:"tokio"})," \u4f5c\u70ba\u975e\u540c\u6b65\u57f7\u884c\u6642\u3002\u4ee5\u4e0b\u662f\u4e00\u500b\u57fa\u672c\u7684\u58d3\u529b\u6e2c\u8a66\u7bc4\u4f8b\uff0c\u5c55\u793a\u5982\u4f55\u5be6\u4f5c\u9019\u6a23\u7684\u6e2c\u8a66\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u6b64\u4ee3\u78bc\u7247\u6bb5\u5047\u8a2d\u4f60\u5df2\u7d93\u6709\u4e00\u500b\u57f7\u884c\u4e2d\u7684 API \u670d\u52d9\uff0c\u53ef\u4ee5\u8655\u7406\u4e0a\u6587\u4e2d\u63d0\u5230\u7684\u5132\u503c\u8acb\u6c42\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u6b65\u9a5f-1-\u52a0\u5165\u4f9d\u8cf4",children:"\u6b65\u9a5f 1: \u52a0\u5165\u4f9d\u8cf4"}),"\n",(0,t.jsxs)(n.p,{children:["\u9996\u5148\uff0c\u4f60\u9700\u8981\u5728 ",(0,t.jsx)(n.code,{children:"Cargo.toml"})," \u6587\u4ef6\u4e2d\u52a0\u5165\u5fc5\u8981\u7684\u4f9d\u8cf4\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'[dependencies]\ntokio = { version = "1.0", features = ["full"] }\nreqwest = "0.11"\nfutures-util = "0.3"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6b65\u9a5f-2-\u5be6\u4f5c\u58d3\u529b\u6e2c\u8a66",children:"\u6b65\u9a5f 2: \u5be6\u4f5c\u58d3\u529b\u6e2c\u8a66"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:'use reqwest::Client;\nuse futures_util::stream::{self, StreamExt};\nuse tokio::time::{self, Duration};\n\n#[tokio::main]\nasync fn main() {\n    let client = Client::new();\n    let request_count = 10_000; // \u76ee\u6a19\u8acb\u6c42\u6578\n    let concurrent_requests = 1000; // \u540c\u6642\u4e26\u767c\u8acb\u6c42\u7684\u6578\u91cf\n\n    let request_stream = stream::iter(0..request_count).map(|_| {\n        let client = &client;\n        tokio::spawn(async move {\n            let transaction_id = uuid::Uuid::new_v4().to_string(); // \u5047\u8a2d\u6bcf\u500b\u8acb\u6c42\u6709\u552f\u4e00\u7684 transaction_id\n            let user_id = 1; // \u5047\u8a2d\u7528\u6236 ID \u70ba 1\n            let amount = 100; // \u5047\u8a2d\u5132\u503c\u91d1\u984d\u70ba 100\n\n            let res = client.post("http://localhost:8080/recharge") // \u66ff\u63db\u70ba\u4f60\u7684 API \u7aef\u9ede\n                .json(&serde_json::json!({\n                    "user_id": user_id,\n                    "amount": amount,\n                    "transaction_id": transaction_id,\n                }))\n                .send()\n                .await;\n\n            match res {\n                Ok(response) => println!("Response: {:?}", response.text().await),\n                Err(e) => println!("Request failed: {:?}", e),\n            }\n        });\n    }).buffer_unordered(concurrent_requests);\n\n    // \u9650\u5236\u7e3d\u57f7\u884c\u6642\u9593\u4ee5\u907f\u514d\u7121\u9650\u57f7\u884c\n    let timeout = Duration::from_secs(10);\n    let _ = time::timeout(timeout, request_stream.for_each(|_| async {})).await;\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u8aaa\u660e",children:"\u8aaa\u660e"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u9019\u500b\u6e2c\u8a66\u8173\u672c\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"tokio::spawn"})," \u4f86\u975e\u540c\u6b65\u767c\u9001\u8acb\u6c42\uff0c\u4e26\u900f\u904e ",(0,t.jsx)(n.code,{children:"futures_util::stream::StreamExt::buffer_unordered"})," \u9650\u5236\u4e86\u540c\u6642\u4e26\u767c\u7684\u8acb\u6c42\u6578\u91cf\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6211\u5011\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"reqwest::Client"})," \u4f86\u767c\u9001 HTTP POST \u8acb\u6c42\uff0c\u6a21\u64ec\u5132\u503c\u64cd\u4f5c\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6bcf\u500b\u8acb\u6c42\u90fd\u6709\u4e00\u500b\u552f\u4e00\u7684 ",(0,t.jsx)(n.code,{children:"transaction_id"})," \u4f86\u6a21\u64ec\u771f\u5be6\u4e16\u754c\u7684\u5e42\u7b49\u6027\u9700\u6c42\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"time::timeout"})," \u7528\u65bc\u78ba\u4fdd\u6574\u500b\u58d3\u529b\u6e2c\u8a66\u5728\u6307\u5b9a\u6642\u9593\u5f8c\u7d42\u6b62\uff0c\u9632\u6b62\u6e2c\u8a66\u7121\u9650\u57f7\u884c\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["\u8acb\u6ce8\u610f\uff0c\u9019\u500b\u6e2c\u8a66\u8173\u672c\u4e3b\u8981\u7528\u65bc\u793a\u7bc4\u548c\u6559\u5b78\u76ee\u7684\u3002\u5728\u5be6\u969b\u7684\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u66f4\u5c08\u696d\u7684\u8ca0\u8f09\u6e2c\u8a66\u5de5\u5177\uff08\u5982 ",(0,t.jsx)(n.code,{children:"wrk"}),"\u3001",(0,t.jsx)(n.code,{children:"JMeter"})," \u6216 ",(0,t.jsx)(n.code,{children:"Gatling"}),"\uff09\u4f86\u7372\u5f97\u66f4\u7cbe\u78ba\u7684\u6027\u80fd\u6307\u6a19\u548c\u66f4\u5ee3\u6cdb\u7684\u6e2c\u8a66\u60c5\u666f\u3002\u6b64\u5916\uff0c\u78ba\u4fdd\u4f60\u7684 API \u7aef\u9ede\u548c\u6e2c\u8a66\u74b0\u5883\u6e96\u5099\u597d\u627f\u53d7\u9019\u7a2e\u9ad8\u5f37\u5ea6\u7684\u58d3\u529b\u6e2c\u8a66\u3002"]})})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},1151:(e,n,s)=>{s.d(n,{Z:()=>d,a:()=>c});var t=s(7294);const i={},r=t.createContext(i);function c(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);